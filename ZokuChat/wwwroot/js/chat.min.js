class Room{constructor(n,t,i){this.id=n;this.creatorId=t;this.currentUserId=i}}class Error{constructor(n,t){this.caption=n;this.message=t}}class Broadcast{constructor(n,t){this.streamId=n;this.userId=t}}window.ZokuChat.chat={};window.ZokuChat.chat.room=null;var app=new Vue({el:"#chat-app",data:{window:window,connection:(new signalR.HubConnectionBuilder).withUrl("/chatHub").build(),peerConnection:new RTCPeerConnection({iceServers:[{urls:"stun:stun.1.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),contacts:[],messages:[],streams:[],broadcasting:!1,broadcasts:[],errors:[]},methods:{init:()=>{app.connection.on("ReceiveMessages",function(n){n.forEach(function(n){app.messages.push(n)});app.$nextTick(()=>{app.scrollToLatestMessage()})});app.connection.on("ReceiveContact",function(n){app.broadcasting&&app.sendOfferToUser(n.userUID)});app.connection.on("ReceiveContacts",function(n){n.forEach(function(n){app.contacts.push(n)})});app.connection.on("ReceiveMessage",function(n){app.messages.push(n);app.$nextTick(()=>{app.scrollToLatestMessage()})});app.connection.on("ReceiveDeleteMessage",function(n){let t=app.messages.findIndex(function(t){return t.id===n.id});t>-1&&app.messages.splice(t,1,n)});app.connection.on("ReceiveBroadcast",function(n){app.broadcasts.push(new Broadcast(n.streamId,n.userId))});app.connection.on("ReceiveDeleteBroadcast",function(n){let t=app.broadcasts.findIndex(function(t){return t.userId===n.userId});if(t>-1){let n=app.streams.findIndex(function(n){return n.id===app.broadcasts[t].streamId});n>-1&&(app.streams[n].getTracks().forEach(n=>n.stop),app.streams.splice(n,1));app.broadcasts.splice(t,1)}});app.connection.on("ReceiveError",function(n,t){app.errors.push(n,t)});app.connection.start().then(function(){app.joinRoom().then(()=>app.retrieveMessages())});app.peerConnection.ontrack=function(n){if(app.streams.findIndex(t=>t.id===n.streams[0].id)===-1){let t=n.streams[0];app.streams.push(t);let i=app.broadcasts.findIndex(function(n){return n.streamId===t.id});if(i>-1){let n=app.broadcasts[i];app.$nextTick(()=>{document.querySelector(`video#broadcast-${n.userId}`).srcObject=t})}}};app.peerConnection.onnegotiationneeded=function(){app.peerConnection.createOffer().then(n=>app.peerConnection.setLocalDescription(n)).then(()=>app.sendOffer())};app.peerConnection.onicecandidate=function(n){n.candidate&&app.sendCandidate(n.candidate)};app.connection.on("ReceiveOffer",function(n,t){app.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(n)));app.peerConnection.createAnswer().then(n=>{app.peerConnection.setLocalDescription(n),app.sendAnswer(n,t)})});app.connection.on("ReceiveAnswer",function(n,t){t===window.ZokuChat.chat.room.currentUserId&&app.peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(n)))});app.connection.on("ReceiveCandidate",function(n){app.peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(n)))})},joinRoom:()=>app.connection.invoke("JoinRoom",window.ZokuChat.chat.room.id),retrieveMessages:()=>app.connection.invoke("GetMessages",window.ZokuChat.chat.room.id),sendMessage:n=>app.connection.invoke("SendMessage",window.ZokuChat.chat.room.id,n),sendButtonClick:()=>{$("#message-input").val().length>0&&(app.sendMessage($("#message-input").val()),$("#message-input").val(""))},sendOffer:()=>app.connection.invoke("SendOffer",window.ZokuChat.chat.room.id,JSON.stringify(app.peerConnection.localDescription)),sendOfferToUser:n=>app.connection.invoke("SendOfferToUser",window.ZokuChat.chat.room.id,n,JSON.stringify(app.peerConnection.localDescription)),sendAnswer:(n,t)=>app.connection.invoke("SendAnswer",window.ZokuChat.chat.room.id,t,JSON.stringify(n)),sendCandidate:n=>app.connection.invoke("SendCandidate",window.ZokuChat.chat.room.id,JSON.stringify(n)),deleteMessage:n=>app.connection.invoke("DeleteMessage",window.ZokuChat.chat.room.id,n.id),canDeleteMessage:n=>{let t=window.ZokuChat.chat.room.currentUserId;return t===n.userId||t===window.ZokuChat.chat.room.creatorId},scrollToLatestMessage:()=>{let n=$("#messages-container");n.scrollTop(n.height())},startBroadcast:()=>{navigator.mediaDevices.getUserMedia({video:{width:{min:640,ideal:1920,max:1920},height:{min:480,ideal:1080,max:1080}},audio:!0}).then(function(n){let t=new Broadcast(n.id,window.ZokuChat.chat.room.currentUserId);app.broadcasts.push(t);app.$nextTick(()=>{document.querySelector(`video#broadcast-${t.userId}`).srcObject=n});app.connection.invoke("StartBroadcast",window.ZokuChat.chat.room.id,new Broadcast(n.id,window.ZokuChat.chat.room.currentUserId)).then(()=>{app.broadcasting=!0,app.streams.push(n),n.getTracks().forEach(t=>app.peerConnection.addTrack(t,n)),app.peerConnection.createOffer().then(n=>app.peerConnection.setLocalDescription(n)).then(()=>app.sendOffer())})})},stopBroadcast:()=>app.connection.invoke("StopBroadcast",window.ZokuChat.chat.room.id).then(()=>app.broadcasting=!1)}});